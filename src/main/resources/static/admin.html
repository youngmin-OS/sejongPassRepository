<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>관리자 - 합격생 인증 관리</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }

    .wrap {
      max-width: 1100px;
      margin: 30px auto;
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 16px;
    }

    .card {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.08);
    }

    h2 {
      margin: 0 0 12px 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      border-bottom: 1px solid #eee;
      padding: 10px;
      text-align: left;
      font-size: 14px;
    }

    tr:hover {
      background: #fafafa;
      cursor: pointer;
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    select,
    input,
    textarea,
    button {
      padding: 8px;
      font-size: 14px;
    }

    textarea {
      width: 100%;
      height: 80px;
    }

    button {
      background: #8b0000;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover {
      background: #a30000;
    }

    .muted {
      color: #666;
      font-size: 13px;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #ddd;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- 좌측: 목록 -->
    <div class="card">

      <h2>지원자 목록</h2>

      <div class="row" style="margin-bottom:10px;">
        <label class="muted">상태 필터</label>
        <select id="statusFilter">
          <option value="">전체</option>
          <option value="PENDING">PENDING</option>
          <option value="APPROVED">APPROVED</option>
          <option value="REJECTED">REJECTED</option>
        </select>
        <button onclick="loadApplicants()">새로고침</button>
        <span id="count" class="muted"></span>
      </div>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>이름</th>
            <th>전화번호</th>
            <th>상태</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- 우측: 상세/처리 -->
    <div class="card">
      <h2>선택한 지원자</h2>
      <div id="detail" class="muted">왼쪽 목록에서 지원자를 클릭하세요.</div>

      <hr style="margin:14px 0; border:0; border-top:1px solid #eee;" />

      <h3 style="margin:0 0 10px 0;">승인 처리</h3>
      <div class="row">
        <input id="openKakaoUrl" style="width:100%;" placeholder="오픈카카오 URL" />
        <input id="meetingPlace" style="width:100%;" placeholder="미팅 장소" />
        <button onclick="approve()">승인</button>
      </div>

      <hr style="margin:14px 0; border:0; border-top:1px solid #eee;" />

      <h3 style="margin:0 0 10px 0;">반려 처리</h3>
      <textarea id="rejectReason" placeholder="반려 사유"></textarea>
      <div class="row" style="margin-top:8px;">
        <button onclick="reject()">반려</button>
        <button onclick="downloadFile()" style="background:#333;">파일 다운로드</button>
        <button onclick="deleteApplicant()" style="background:#555;">삭제</button>
      </div>

      <p id="msg" class="muted" style="margin-top:10px;"></p>
    </div>

  </div>

  <div style="text-align: center; margin-bottom: 50px;">
    <button onclick="location.href='index.html'" style="background: #666; padding: 10px 24px; font-weight: bold;">
      메인 페이지로 이동
    </button>
  </div>

  <script>
    let selectedId = null;

    async function loadApplicants() {
      const status = document.getElementById('statusFilter').value;
      const url = status
        ? `/api/admin/applicants?status=${encodeURIComponent(status)}`
        : `/api/admin/applicants`;

      const res = await fetch(url);
      if (!res.ok) {
        alert("목록 조회 실패: " + res.status);
        return;
      }
      const list = await res.json();
      document.getElementById('count').innerText = `총 ${list.length}명`;

      const tbody = document.getElementById('tbody');
      tbody.innerHTML = "";

      list.forEach(a => {
        const tr = document.createElement('tr');
        tr.onclick = () => selectApplicant(a);

        tr.innerHTML = `
          <td>${a.id}</td>
          <td>${a.name ?? ""}</td>
          <td>${a.phoneNumber ?? ""}</td>
          <td><span class="pill">${a.status ?? ""}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function selectApplicant(a) {
      selectedId = a.id;
      document.getElementById('detail').innerHTML = `
        <div><b>ID:</b> ${a.id}</div>
        <div><b>이름:</b> ${a.name ?? ""}</div>
        <div><b>전화번호:</b> ${a.phoneNumber ?? ""}</div>
        <div><b>입학년도:</b> ${a.admissionYear ?? ""}</div>
        <div><b>상태:</b> ${a.status ?? ""}</div>
        <div><b>반려사유:</b> ${a.rejectReason ?? "-"}</div>
        <div><b>오픈카카오:</b> ${a.openKakaoUrl ?? "-"}</div>
        <div><b>미팅장소:</b> ${a.meetingPlace ?? "-"}</div>
      `;

      document.getElementById('openKakaoUrl').value = a.openKakaoUrl ?? "";
      document.getElementById('meetingPlace').value = a.meetingPlace ?? "";
      document.getElementById('rejectReason').value = a.rejectReason ?? "";
      document.getElementById('msg').innerText = "";
    }

    async function approve() {
      if (!selectedId) return alert("지원자를 선택하세요.");

      const openKakaoUrl = document.getElementById('openKakaoUrl').value.trim();
      const meetingPlace = document.getElementById('meetingPlace').value.trim();
      if (!openKakaoUrl || !meetingPlace) return alert("오픈카카오 URL과 미팅 장소를 입력하세요.");

      const body = { action: "APPROVED", openKakaoUrl, meetingPlace };

      const res = await fetch(`/api/admin/review/${selectedId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (!res.ok) return alert("승인 실패: " + res.status);
      document.getElementById('msg').innerText = "✅ 승인 처리 완료";
      await loadApplicants();
    }

    async function reject() {
      if (!selectedId) return alert("지원자를 선택하세요.");

      const rejectReason = document.getElementById('rejectReason').value.trim();
      if (!rejectReason) return alert("반려 사유를 입력하세요.");

      const body = { action: "REJECTED", rejectReason };

      const res = await fetch(`/api/admin/review/${selectedId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (!res.ok) return alert("반려 실패: " + res.status);
      document.getElementById('msg').innerText = "✅ 반려 처리 완료";
      await loadApplicants();
    }

    function downloadFile() {
      if (!selectedId) return alert("지원자를 선택하세요.");
      window.open(`/api/admin/file/${selectedId}`, "_blank");
    }

    async function deleteApplicant() {
      if (!selectedId) return alert("지원자를 선택하세요.");

      const ok = confirm("정말 이 지원자를 삭제하시겠습니까?\n삭제하면 복구할 수 없습니다.");
      if (!ok) return;

      const res = await fetch(`/api/admin/applicants/${selectedId}`, {
        method: "DELETE"
      });

      if (!res.ok) {
        alert("삭제 실패: " + res.status);
        return;
      }

      alert("✅ 지원자가 삭제되었습니다.");
      selectedId = null;
      document.getElementById('detail').innerText =
        "왼쪽 목록에서 지원자를 클릭하세요.";
      await loadApplicants();
    }

    loadApplicants();
  </script>
</body>

</html>